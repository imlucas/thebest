<html>
  <head>
	<script src="https://s3.amazonaws.com/stitch-sdks/js/bundles/4.1.1/stitch.js"></script>

    <script>
      // Initialize the App Client
	  const client = stitch.Stitch.initializeDefaultAppClient('best-fzcva');

      // Get a MongoDB Service Client
      const mongodb = client.getServiceClient(
        stitch.RemoteMongoClient.factory,
        "mongodb-atlas"
      );
      // Get a reference to the blog database
      const db = mongodb.db("test");

      function displayYears() {
        const pipeline = [{
          "$group": {
		    "_id": null,
		    "yearList": {
			  "$addToSet": {
		  	     "year": "$year"
              }
		    }
          }
        },
        { "$unwind": { "path": "$yearList"} },
        { "$project": {"year": "$yearList.year"}}
        ]
        db.collection("best")
          .aggregate(pipeline)
          .asArray()
          .then(displayYearsTable);
      }

      function displayYearsOnLoad() {
        client.auth
          .loginWithCredential(new stitch.AnonymousCredential())
          .then(displayYears)
          .catch(console.error);
      }

      // Renders the years information in the table
      function displayYearsTable(years) {
        const yearsTableBody = document.getElementById("years");
        const numResultsEl = document.getElementById("num-results");
        const tableRows = years.map(year => {
          return `
            <tr>
              <td>
								<a id="yearLink" href="#" onclick="expandYear(${year.year}); return false; ">${year.year}</a>
							</td>
            </tr>
          `;
        });
        yearsTableBody.innerHTML = tableRows.join("");
        numResultsEl.innerHTML = years.length;
      }

    </script>
  </head>

  <body onLoad="displayYearsOnLoad()">
    <h3>All the best</h3>
    <hr>
		<div class="results-bar">
			<p>Total Years:<span id="num-results" class="results-bar__count"></span></p>
		</div>
		<table class="table table-striped">
			<thead class="thead">
				<tr>
					<th>Year</th>
				</tr>
			</thead>
			<tbody id='years'></tbody>
		</table>
    <hr>
  </body>

</html>
